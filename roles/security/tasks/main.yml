---
- name: sshd_config
  block:
    - lineinfile: path=/etc/ssh/sshd_config backrefs=yes
                  regexp="^\s*({{ item }})" line="\1 no"
      with_items:
        - PermitRootLogin
        - PermitEmptyPasswords

    - name: ipv4 only
      lineinfile: path=/etc/ssh/sshd_config backrefs=yes
                  regexp="^[\s#]*(AddressFamily)" line="\1 inet4"

    - name: no ipv6 listen
      lineinfile: path=/etc/ssh/sshd_config
                  regexp="^[\s#]*ListenAddress ::" state=absent

    - name: LogLevel to show key fingerprints
      lineinfile: path=/etc/ssh/sshd_config backrefs=yes
                  regexp="^\s*(LogLevel)" line="\1 VERBOSE"

    - name: LoginGraceTime
      lineinfile: path=/etc/ssh/sshd_config backrefs=yes
                  regexp="^[\s#]*(LoginGraceTime)" line="\1 15"

    - name: MaxAuthTries
      lineinfile: path=/etc/ssh/sshd_config backrefs=yes
                  regexp="^[\s#]*(MaxAuthTries)" line="\1 3"

    - name: PubkeyAuthentication
      lineinfile: path=/etc/ssh/sshd_config backrefs=yes
                  regexp="^[\s#]*(PubkeyAuthentication)" line="\1 yes"

    # - name: AllowUsers
    #   lineinfile: path=/etc/ssh/sshd_config backrefs=yes
    #               regexp="^[\s#]*(AllowUsers)" line="\1 {{ users.admin }}@127.0.0.1"


- name: iptables base setup
  script: files/firewall.sh
...
